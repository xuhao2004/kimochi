<!--pages/message-wall/index.wxml-->
<view class="container">
  <!-- ç­›é€‰å™¨ -->
  <view class="filters-section">
    <scroll-view class="filters-scroll" scroll-x>
      <view class="filters-list">
        <view 
          wx:for="{{filters}}" 
          wx:key="id"
          class="filter-item {{filterType === item.id ? 'active' : ''}}"
          data-filter="{{item.id}}"
          bindtap="onFilterTap"
        >
          <text class="filter-icon">{{item.icon}}</text>
          <text class="filter-name">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>
    
    <!-- æœç´¢æŒ‰é’® -->
    <view class="search-btn" bindtap="onSearchTap">
      <text class="search-icon">ğŸ”</text>
    </view>
  </view>

  <!-- åŠ¨æ€åˆ—è¡¨ -->
  <scroll-view 
    class="posts-scroll"
    scroll-y 
    refresher-enabled="{{true}}"
    refresher-triggered="{{isRefreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    bindscroll="onScroll"
    enhanced="{{true}}"
    bounces="{{true}}"
    show-scrollbar="{{false}}"
  >
    <view class="posts-list">
      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{isLoading && posts.length === 0}}" class="loading-section">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{!isLoading && posts.length === 0}}" class="empty-section">
        <view class="empty-icon">ğŸ’­</view>
        <view class="empty-title">æš‚æ— åŠ¨æ€</view>
        <view class="empty-desc">æˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«å¿ƒæƒ…çš„äºº</view>
        <button wx:if="{{isLoggedIn}}" class="empty-action-btn" bindtap="onCreateTap">
          å‘å¸ƒåŠ¨æ€
        </button>
      </view>

      <!-- åŠ¨æ€åˆ—è¡¨ -->
      <view wx:else class="posts-container">
        <view 
          wx:for="{{posts}}" 
          wx:key="id"
          class="post-card card card-hover fade-in"
          style="animation-delay: {{index * 0.05}}s"
          data-post="{{item}}"
          data-index="{{index}}"
          bindtap="onPostTap"
        >
          <view class="card-body">
            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <view class="post-header">
              <view 
                class="user-info"
                data-user-id="{{item.authorId}}"
                bindtap="onUserTap"
              >
                <image 
                  class="user-avatar avatar avatar-md"
                  src="{{item.author.avatar || '/assets/default/avatar.png'}}"
                  mode="aspectFill"
                />
                <view class="user-details">
                  <view class="user-name">{{item.author.name}}</view>
                  <view class="post-time text-tertiary">{{item._createdAt}}</view>
                </view>
              </view>
              
              <!-- æ›´å¤šæ“ä½œ -->
              <view 
                class="more-btn"
                data-post="{{item}}"
                data-index="{{index}}"
                bindtap="onMoreTap"
              >
                <text class="more-icon">â‹¯</text>
              </view>
            </view>

            <!-- åŠ¨æ€å†…å®¹ -->
            <view class="post-content">
              <rich-text class="content-text" nodes="{{item._content}}"></rich-text>
            </view>

            <!-- å›¾ç‰‡ -->
            <view wx:if="{{item._images.length > 0}}" class="post-images">
              <view class="images-grid images-grid-{{item._images.length > 4 ? 'many' : item._images.length}}">
                <image 
                  wx:for="{{item._images}}" 
                  wx:key="index"
                  wx:for-item="imageUrl"
                  wx:for-index="imageIndex"
                  class="post-image"
                  src="{{imageUrl}}"
                  mode="aspectFill"
                  data-images="{{item._images}}"
                  data-current="{{imageUrl}}"
                  bindtap="onImageTap"
                />
              </view>
            </view>

            <!-- æ“ä½œæ  -->
            <view class="post-actions">
              <view class="action-group">
                <view 
                  class="action-btn like-btn {{item._isLiked ? 'liked' : ''}}"
                  data-post="{{item}}"
                  data-index="{{index}}"
                  bindtap="onLikeTap"
                >
                  <text class="action-icon">{{item._isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
                  <text class="action-text">{{item.likeCount || 0}}</text>
                </view>
                
                <view 
                  class="action-btn"
                  data-post="{{item}}"
                  bindtap="onCommentTap"
                >
                  <text class="action-icon">ğŸ’¬</text>
                  <text class="action-text">{{item.commentCount || 0}}</text>
                </view>
                
                <view 
                  class="action-btn"
                  data-post="{{item}}"
                  bindtap="onShareTap"
                >
                  <text class="action-icon">ğŸ“¤</text>
                  <text class="action-text">åˆ†äº«</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- åŠ è½½æ›´å¤š -->
        <view wx:if="{{hasMore && !isLoading}}" class="load-more">
          <view class="loading-spinner"></view>
          <text class="loading-text">åŠ è½½æ›´å¤š...</text>
        </view>
        
        <!-- æ²¡æœ‰æ›´å¤š -->
        <view wx:elif="{{!hasMore && posts.length > 0}}" class="no-more">
          <text class="no-more-text">æ²¡æœ‰æ›´å¤šåŠ¨æ€äº†</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- æœªç™»å½•æç¤º -->
  <view wx:if="{{!isLoggedIn}}" class="login-tip glass">
    <view class="tip-content">
      <text class="tip-text">ç™»å½•åå¯ä»¥ç‚¹èµã€è¯„è®ºå’Œå‘å¸ƒåŠ¨æ€</text>
      <button class="tip-btn" bindtap="showLoginPrompt">ç«‹å³ç™»å½•</button>
    </view>
  </view>

  <!-- æ‚¬æµ®åˆ›å»ºæŒ‰é’® -->
  <view wx:if="{{isLoggedIn && showCreateBtn}}" class="create-fab" bindtap="onCreateTap">
    <view class="fab-icon">âœï¸</view>
  </view>
</view>

<!-- ä¸‹æ‹‰åˆ·æ–°æç¤º -->
<view wx:if="{{isRefreshing}}" class="refresh-indicator">
  <view class="loading-spinner"></view>
  <text class="refresh-text">åˆ·æ–°ä¸­...</text>
</view>
