<!--pages/messages/index.wxml-->
<view class="container">
  <!-- å¤´éƒ¨æ ‡ç­¾ -->
  <view class="tabs-section">
    <view class="tabs-list">
      <view 
        wx:for="{{tabs}}" 
        wx:key="id"
        class="tab-item {{activeTab === item.id ? 'active' : ''}}"
        data-tab="{{item.id}}"
        bindtap="onTabTap"
      >
        <text class="tab-icon">{{item.icon}}</text>
        <text class="tab-name">{{item.name}}</text>
        <view wx:if="{{item.id === 'unread' && unreadCount > 0}}" class="tab-badge">
          {{unreadCount > 99 ? '99+' : unreadCount}}
        </view>
      </view>
    </view>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <view class="actions">
      <view class="action-btn" bindtap="onSearchToggle">
        <text class="action-icon">ğŸ”</text>
      </view>
      <view class="action-btn" bindtap="onCreateChat">
        <text class="action-icon">âœï¸</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ¡† -->
  <view wx:if="{{showSearch}}" class="search-section fade-in">
    <view class="search-box">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input 
          class="search-input"
          placeholder="æœç´¢èŠå¤©å’Œæ¶ˆæ¯..."
          value="{{searchText}}"
          bindinput="onSearchInput"
        />
        <view wx:if="{{searchText}}" class="clear-btn" bindtap="onSearchClear">
          <text>Ã—</text>
        </view>
      </view>
    </view>
  </view>

  <!-- èŠå¤©åˆ—è¡¨ -->
  <view class="chat-list">
    <!-- æœªç™»å½•çŠ¶æ€ -->
    <view wx:if="{{!isLoggedIn}}" class="login-section">
      <view class="login-content card">
        <view class="login-icon">ğŸ’¬</view>
        <view class="login-title">ç™»å½•åæŸ¥çœ‹æ¶ˆæ¯</view>
        <view class="login-desc">ä¸æœ‹å‹ç§èŠï¼Œåˆ†äº«å¿ƒæƒ…ä½“éªŒ</view>
        <button class="login-btn btn btn-primary" bindtap="onLogin">ç«‹å³ç™»å½•</button>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:elif="{{isLoading}}" class="loading-section">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{filteredRooms.length === 0}}" class="empty-section">
      <view class="empty-icon">
        <text>{{activeTab === 'unread' ? 'âœ…' : (activeTab === 'groups' ? 'ğŸ‘¥' : 'ğŸ’¬')}}</text>
      </view>
      <view class="empty-title">
        {{activeTab === 'unread' ? 'æš‚æ— æœªè¯»æ¶ˆæ¯' : (activeTab === 'groups' ? 'æš‚æ— ç¾¤èŠ' : 'æš‚æ— æ¶ˆæ¯')}}
      </view>
      <view class="empty-desc">
        {{activeTab === 'unread' ? 'æ‰€æœ‰æ¶ˆæ¯éƒ½å·²é˜…è¯»' : (activeTab === 'groups' ? 'åˆ›å»ºæˆ–åŠ å…¥ç¾¤èŠå¼€å§‹äº¤æµ' : 'å¼€å§‹ä¸€æ®µæ–°çš„å¯¹è¯')}}
      </view>
      <button wx:if="{{activeTab !== 'unread'}}" class="empty-action-btn" bindtap="onCreateChat">
        {{activeTab === 'groups' ? 'åˆ›å»ºç¾¤èŠ' : 'å‘èµ·èŠå¤©'}}
      </button>
    </view>

    <!-- èŠå¤©å®¤åˆ—è¡¨ -->
    <view wx:else class="rooms-list">
      <view 
        wx:for="{{filteredRooms}}" 
        wx:key="id"
        class="room-item {{item.isPinned ? 'pinned' : ''}} fade-in"
        style="animation-delay: {{index * 0.05}}s"
        data-room="{{item}}"
        data-index="{{index}}"
        bindtap="onRoomTap"
        bindlongpress="onRoomLongPress"
      >
        <!-- ç½®é¡¶æ ‡è¯† -->
        <view wx:if="{{item.isPinned}}" class="pin-indicator">ğŸ“Œ</view>
        
        <view class="room-content">
          <!-- å¤´åƒ -->
          <view class="room-avatar-wrapper" data-room="{{item}}" bindtap="onAvatarTap">
            <image 
              class="room-avatar avatar avatar-lg"
              src="{{item._avatar}}"
              mode="aspectFill"
            />
            <view wx:if="{{item._unreadCount > 0}}" class="unread-badge">
              {{item._unreadCount > 99 ? '99+' : item._unreadCount}}
            </view>
            <view wx:if="{{item._isGroup}}" class="group-indicator">
              <text>ğŸ‘¥</text>
            </view>
          </view>

          <!-- èŠå¤©ä¿¡æ¯ -->
          <view class="room-info">
            <view class="room-header">
              <text class="room-title {{item._unreadCount > 0 ? 'unread' : ''}}">
                {{item._title}}
              </text>
              <text class="room-time">{{item._lastMessageTime}}</text>
            </view>
            
            <view class="room-subtitle">
              <text class="last-message {{item._unreadCount > 0 ? 'unread' : ''}}">
                {{item._lastMessageText}}
              </text>
              <view wx:if="{{item._unreadCount > 0}}" class="unread-dot"></view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area"></view>
</view>